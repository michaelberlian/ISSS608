---
title: "Take-Home Exercise 1"
date: "14 January 2024"
date-modified: "last-modified"
execute: 
  eval: true
  echo: true
  warning: false
editor: visual
---

## Prologue

In this Take home Exercise we are going to explore the data from [PISA 2022 database](https://www.oecd.org/pisa/data/2022database/) released on 5 December 2022. The dataset is the result of questionnaire filled by the students.

## Getting Started

### Importing packages

In this take home exercise we are going to utilise several package

1.  tidyverse (to wrangle and plot our data)
2.  haven (to read our dataset from sas data type)
3.  patchwork (to plot multiple plot in the same figure)
4.  ggrain, to plot ggrain (combination of distribution, box plot, and scatter plot)

```{r}
pacman::p_load(tidyverse, haven, patchwork, ggrain)
```

### Importing dataset

Importing the data in sas data type

```{r}
#| eval: false
stu_qqq <- read_sas('data/cy08msp_stu_qqq.sas7bdat')
```

filtering the data to singapore

```{r}
#| eval: false
stu_qqq_SG <- stu_qqq %>%
  filter(CNT == "SGP")
```

export the filtered dataset to rds to ease further data importing

```{r}
#| eval: false
write_rds(stu_qqq_SG, 'data/stu_qqq_SG.rds')
```

read the exported rds

```{r}
stu_qqq_SG <- read_rds('data/stu_qqq_SG.rds')
```

## Data Preparation

### Variable preparations

-   filtering the columns that will be used for further analysis

-   rename the columns to a more understandable names

-   recode the answers of questions to a more descriptive measures

-   change the columns data type

```{r}
stu_qqq <- stu_qqq_SG %>%
  select(CNTSCHID,ST004D01T,PV1MATH,PV1SCIE,PV1READ,ST255Q01JA,ST251Q01JA,ST253Q01JA) %>%
  rename(c(school_ID = "CNTSCHID", 
           gender = "ST004D01T",
           math = "PV1MATH",
           science = "PV1SCIE",
           read = "PV1READ",
           num_book = "ST255Q01JA",
           num_transport = "ST251Q01JA",
           num_digital_devices = "ST253Q01JA")) %>%
  mutate(gender = recode(gender, 
                         "1" = "Female", 
                         "2" = "Male")) %>%
  mutate(num_book = recode(num_book,
                           "1" = "None",
                           "2" = "1-10",
                           "3" = "11-25",
                           "4" = "26-100",
                           "5" = "101-200",
                           "6" = "201-500",
                           "7" = "500+")) %>%
  mutate(num_transport = recode(num_transport,
                                "1" = "None",
                                "2" = "1",
                                "3" = "2",
                                "4" = "3+")) %>%
  mutate(num_digital_devices = recode (num_digital_devices,
                                       "1" = "None",
                                       "2" = "1",
                                       "3" = "2",
                                       "4" = "3",
                                       "5" = "4",
                                       "6" = "5",
                                       "7" = "6-10",
                                       "8" = "10+"))


stu_qqq$school_ID <- as.factor(stu_qqq$school_ID)
stu_qqq$gender <- as.factor(stu_qqq$gender)
stu_qqq$num_book <- as.factor(stu_qqq$num_book)
stu_qqq$num_book <- factor(stu_qqq$num_book, levels = c('None','1-10','11-25','26-100','101-200','201-500','500+'))
stu_qqq$num_transport <- as.factor(stu_qqq$num_transport)
stu_qqq$num_transport <- factor(stu_qqq$num_transport, levels = c('None','1','2','3+'))
stu_qqq$num_digital_devices <- as.factor(stu_qqq$num_digital_devices)
stu_qqq$num_digital_devices <- factor(stu_qqq$num_digital_devices, levels = c('None','1','2','3','4','5','6-10','10+'))
```

### Overview

#### Dataset

```{r}
glimpse(stu_qqq)
```

#### Scores Distribution

```{r}
p1 <- ggplot(data = stu_qqq,
       aes(y = math)) +
  geom_boxplot()+
  stat_boxplot(geom = "errorbar", width = 0.05) +
  stat_summary(aes(x = 0),
               geom = "point",       
               fun.y = "mean",         
               colour = "red", 
               size = 1) +
  ylim(c(0,1000))+
  scale_x_continuous(NULL, breaks = NULL) +
  theme_minimal()
p2 <- ggplot(data = stu_qqq,
       aes(y = science)) +
  geom_boxplot()+
  stat_boxplot(geom = "errorbar", width = 0.05) +
  stat_summary(aes(x = 0),
               geom = "point",       
               fun.y = "mean",         
               colour = "red", 
               size = 1) +
  ylim(c(0,1000))+
  scale_x_continuous(NULL, breaks = NULL) +
  theme_minimal()
p3 <- ggplot(data = stu_qqq,
       aes(y = read)) +
  geom_boxplot()+
  stat_boxplot(geom = "errorbar", width = 0.05) +
  stat_summary(aes(x = 0),
               geom = "point",       
               fun.y = "mean",         
               colour = "red", 
               size = 1) +
  ylim(c(0,1000))+
  scale_x_continuous(NULL, breaks = NULL) +
  theme_minimal()

p1|p2|p3
```

## Exploratory Data Analysis (EDA)

In this section 5 analysis will be performed to get insights and uncover truth of factors for singapore student perfomances.

### 1. Gender

the first factor that we are going to look into is gender.

```{r}
ggplot(data = stu_qqq,
       aes(x = gender)) +
  geom_bar(width = 0.5,
           color = "grey50",
           fill = "grey90")+
  theme_minimal()
```

from the distribution graph above can be seen that the questionnaire have similar number of male and female student.

::: panel-tabset
#### Math

from the graph below, can be seen that there are **VERY SMALL** differences between male and female science scores, with male have a **SLIGHTLY HIGHER** average and median score

```{r}
#| code-fold: true
#| code-summary: "Show the code"
stats <- data.frame(gender = as.factor(c('Female','Male')),
                    mean = c(mean(stu_qqq$math[stu_qqq$gender == "Female"]),
                             mean(stu_qqq$math[stu_qqq$gender == "Male"])),
                    median = c(median(stu_qqq$math[stu_qqq$gender == "Female"]),
                               median(stu_qqq$math[stu_qqq$gender == "Male"])) )

ggplot(data = stu_qqq,
       aes(y = math)) +
  geom_histogram(bins = 10,
                 color = 'grey50',
                 fill = 'grey90') +
  facet_wrap(~ gender) +
  geom_hline(data = stats,
             mapping = aes(yintercept=mean),
             color = "red") +
  geom_hline(data = stats,
             mapping = aes(yintercept=median),
             color = "blue") +
  annotate(
    'text',
    x = Inf,
    y = Inf,
    hjust = 1,
    vjust = 2.1,
    label = paste("MEAN"),
    color = "red"
  ) +
  annotate(
    'text',
    x = Inf,
    y = Inf,
    hjust = 1,
    vjust = 1,
    label = paste("MEDIAN"),
    color = "blue"
  ) +
  theme_minimal()
```

#### Science

from the graph below, can be seen that there are **VERY SMALL** differences between male and female science scores, with male have a **SLIGHTLY HIGHER** average and median score

```{r}
#| code-fold: true
#| code-summary: "Show the code"
stats <- data.frame(gender = as.factor(c('Female','Male')),
                    mean = c(mean(stu_qqq$science[stu_qqq$gender == "Female"]),
                             mean(stu_qqq$science[stu_qqq$gender == "Male"])),
                    median = c(median(stu_qqq$science[stu_qqq$gender == "Female"]),
                               median(stu_qqq$science[stu_qqq$gender == "Male"])) )

ggplot(data = stu_qqq,
       aes(y = science)) +
  geom_histogram(bins = 10,
                 color = 'grey50',
                 fill = 'grey90') +
  facet_wrap(~ gender) +
  geom_hline(data = stats,
             mapping = aes(yintercept=mean),
             color = "red") +
  geom_hline(data = stats,
             mapping = aes(yintercept=median),
             color = "blue") +
  annotate(
    'text',
    x = Inf,
    y = Inf,
    hjust = 1,
    vjust = 2.1,
    label = paste("MEAN"),
    color = "red"
  ) +
  annotate(
    'text',
    x = Inf,
    y = Inf,
    hjust = 1,
    vjust = 1,
    label = paste("MEDIAN"),
    color = "blue"
  ) +
  theme_minimal()
```

#### Reading

from the graph below, can be seen that there are **VERY SMALL** differences between male and female reading scores, with male have a **SLIGHTLY LOWER** average and median score

```{r}
#| code-fold: true
#| code-summary: "Show the code"
stats <- data.frame(gender = as.factor(c('Female','Male')),
                    mean = c(mean(stu_qqq$read[stu_qqq$gender == "Female"]),
                             mean(stu_qqq$read[stu_qqq$gender == "Male"])),
                    median = c(median(stu_qqq$read[stu_qqq$gender == "Female"]),
                               median(stu_qqq$read[stu_qqq$gender == "Male"])) )

ggplot(data = stu_qqq,
       aes(y = read)) +
  geom_histogram(bins = 10,
                 color = 'grey50',
                 fill = 'grey90') +
  facet_wrap(~ gender) +
  geom_hline(data = stats,
             mapping = aes(yintercept=mean),
             color = "red") +
  geom_hline(data = stats,
             mapping = aes(yintercept=median),
             color = "blue") +
  annotate(
    'text',
    x = Inf,
    y = Inf,
    hjust = 1,
    vjust = 2.1,
    label = paste("MEAN"),
    color = "red"
  ) +
  annotate(
    'text',
    x = Inf,
    y = Inf,
    hjust = 1,
    vjust = 1,
    label = paste("MEDIAN"),
    color = "blue"
  ) +
  theme_minimal()
```
:::

Overall, can be concluded that student's performances are **EQUAL** no matter the gender is.

### 2. School

```{r}
length(unique(stu_qqq$school_ID))
```

the student that was participating in this questionnaire was from 164 different school in singapore

```{r}
average_math_SG <- mean(stu_qqq$math)
average_scie_SG <- mean(stu_qqq$science)
average_read_SG <- mean(stu_qqq$read)

stu_qqq_sch <- stu_qqq %>%
  group_by(school_ID) %>%
  mutate(average_math_diff = abs(mean(math)-average_math_SG),
         average_science_diff = abs(mean(science)-average_scie_SG),
         average_read_diff = abs(mean(read)-average_read_SG)) %>%
  select(school_ID, average_math_diff, average_science_diff, average_read_diff) %>%
  unique() 

```

on the code above we are going to calculate the average of performance of student across Singapore.

followed by calculating the error or the differences between each school average and the average in singapore.

```{r}
#| code-fold: true
#| code-summary: "Show the code"

p1 <- ggplot(data = stu_qqq_sch,
       aes(y = average_math_diff)) +
  geom_boxplot(width = 0.1) +
  stat_boxplot(geom = "errorbar", width = 0.05) +
  stat_summary(aes(x = 0),
               geom = "point",       
               fun.y = "mean",         
               colour = "red", 
               size = 1) +
  ylim(c(0,220)) +
  scale_x_continuous(NULL, breaks = NULL) +
  theme_minimal()

p2 <- ggplot(data = stu_qqq_sch,
       aes(y = average_science_diff)) +
  geom_boxplot(width = 0.1) +
  stat_boxplot(geom = "errorbar", width = 0.05) +
  stat_summary(aes(x = 0),
               geom = "point",       
               fun.y ="mean",         
               colour ="red", 
               size=1) +
  ylim(c(0,220)) +
  scale_x_continuous(NULL, breaks = NULL) +
  theme_minimal()

p3 <- ggplot(data = stu_qqq_sch,
       aes(y = average_read_diff)) +
  geom_boxplot(width = 0.1) +
  stat_boxplot(geom = "errorbar", width = 0.05) +
  stat_summary(aes(x = 0),
               geom = "point",       
               fun.y ="mean",         
               colour ="red", 
               size=1) +
  ylim(c(0,220)) +
  scale_x_continuous(NULL, breaks = NULL) +
  theme_minimal()

p1|p2|p3
```

the plots above show that the differences between all study subject were similar. however, the differences between a school and the singapore average are ranged from 0 to 220. and the average differences is around 40. this mean that not every single school in Singapore are having the same performance with each other.

on the other hand, the q3 of the box plot lay around 70 point scores. this mean that almost 75% of school in singapore are located between 0-70 point difference to national average. on the other side, there are some school that are having almost 150 point difference either higher or lower against the national average.

### 3. Social Economic 1: Book Ownership

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq,
       aes(x = num_book)) +
  geom_bar(color = "grey50",
           fill = "grey90")+
  theme_minimal()
```

can be seen from initial plotting that our book ownership are not skewed. Also, there is some data that has no value. Therefore, we are going to remove it from our analysis using `drop_na()`.

```{r}
#| code-fold: true
#| code-summary: "Show wrangling code"
stu_qqq_book <- stu_qqq %>%
  select(math, science, read, num_book) %>%
  drop_na()
```

here is the new distribution after removing the na value rows.

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_book,
       aes(x = num_book)) +
  geom_bar(color = "grey50",
           fill = "grey90")+
  theme_minimal()
```

::: panel-tabset
#### Math

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_book,
       aes(y = math, x = num_book)) +
  geom_violin()+
  stat_summary(fun = 'mean',
               geom = 'point',
               color = 'red')+
  theme_minimal()
```

#### Science

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_book,
       aes(y = science, x = num_book)) +
  geom_violin()+
  stat_summary(fun = 'mean',
               geom = 'point',
               color = 'red')+
  theme_minimal()
```

#### Reading

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_book,
       aes(y = read, x = num_book)) +
  geom_violin()+
  stat_summary(fun = 'mean',
               geom = 'point',
               color = 'red')+
  theme_minimal()
```
:::

from all the three plots can be seen that with more of number of book owned, the lower value does not change much and the upper limit is growing. further more the red dots which represent mean also going up for every more book owned. however, there is an exception on the student who own more than 500 book, where their average is not raising instead it is lower than students who have 201-500 books.

### 4. Social Economic 2: Digital Device Ownership

```{r}
ggplot(data = stu_qqq,
       aes(x = num_digital_devices)) +
  geom_bar(color = "grey50",
           fill = "grey90")+
  theme_minimal()
```

```{r}
#| code-fold: true
#| code-summary: "Show wrangling code"
stu_qqq_digital <- stu_qqq %>%
  select(num_digital_devices, math, science, read) %>%
  drop_na()
```

```{r}
ggplot(data = stu_qqq_digital,
       aes(x = num_digital_devices)) +
  geom_bar(color = "grey50",
           fill = "grey90")+
  theme_minimal()
```

::: panel-tabset
#### Math

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_digital,
       aes(x = num_digital_devices, y = math)) +
  geom_boxplot()+
  stat_boxplot(geom = "errorbar", width = 0.5) +
  stat_summary(aes(x = num_digital_devices),
               geom = "point",
               fun.y = "mean",
               colour = "red",
               size = 1.5) +
  theme_minimal()
```

#### Science

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_digital,
       aes(x = num_digital_devices, y = science)) +
  geom_boxplot()+
  stat_boxplot(geom = "errorbar", width = 0.5) +
  stat_summary(aes(x = num_digital_devices),
               geom = "point",
               fun.y = "mean",
               colour = "red",
               size = 1.5) +
  theme_minimal()
```

#### Reading

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_digital,
       aes(x = num_digital_devices, y = read)) +
  geom_boxplot()+
  stat_boxplot(geom = "errorbar", width = 0.5) +
  stat_summary(aes(x = num_digital_devices),
               geom = "point",
               fun.y = "mean",
               colour = "red",
               size = 1.5) +
  theme_minimal()
```
:::

### 5. Social Economic 3: Vehicle Ownership

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq,
       aes(x = num_transport)) +
  geom_bar(color = "grey50",
           fill = "grey90")+
  theme_minimal()
```

```{r}
#| code-fold: true
#| code-summary: "Show wrangling code"
stu_qqq_transport <- stu_qqq %>%
  select(math, science, read, num_transport) %>%
  drop_na() 
```

```{r}
ggplot(data = stu_qqq_transport,
       aes(x = num_transport)) +
  geom_bar(color = "grey50",
           fill = "grey90")+
  theme_minimal()
```

::: panel-tabset
#### Math

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(stu_qqq_transport,
       aes(x = num_transport, y = math, fill= num_transport))+
  geom_rain() +
  coord_flip()
```

#### Science

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(stu_qqq_transport,
       aes(x = num_transport, y = science, fill= num_transport))+
  geom_rain() +
  coord_flip()
```

#### Reading

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(stu_qqq_transport,
       aes(x = num_transport, y = read, fill= num_transport))+
  geom_rain() +
  coord_flip()
```
:::
