---
title: "Take-Home Exercise 1"
date: "14 January 2024"
date-modified: "last-modified"
execute: 
  eval: true
  echo: true
  warning: false
editor: visual
---

## Prologue

In this Take home Exercise we are going to explore the data from [PISA 2022 database](https://www.oecd.org/pisa/data/2022database/) released on 5 December 2022. The dataset is the result of questionnaire filled by the students.

## Getting Started

### Importing packages

In this take home exercise we are going to utilise several package

1.  tidyverse
2.  haven
3.  ggrepel
4.  patchwork
5.  ggthemes
6.  hrbrthemes

```{r}
pacman::p_load(tidyverse, haven, ggrepel, patchwork, ggthemes, hrbrthemes)
```

### Importing dataset

Importing the data in sas data type

```{r}
#| eval: false
stu_qqq <- read_sas('data/cy08msp_stu_qqq.sas7bdat')
```

filtering the data to singapore

```{r}
#| eval: false
stu_qqq_SG <- stu_qqq %>%
  filter(CNT == "SGP")
```

export the filtered dataset to rds to ease further data importing

```{r}
#| eval: false
write_rds(stu_qqq_SG, 'data/stu_qqq_SG.rds')
```

read the exported rds

```{r}
stu_qqq_SG <- read_rds('data/stu_qqq_SG.rds')
```

## Data Preparation

### Selecting columns

```{r}
stu_qqq <- stu_qqq_SG %>%
  select(CNTSCHID,ST004D01T,PV1MATH,PV1SCIE,PV1READ,ST255Q01JA,ST251Q01JA,ST253Q01JA) %>%
  rename(c(school_ID = "CNTSCHID", 
           gender = "ST004D01T",
           math = "PV1MATH",
           science = "PV1SCIE",
           read = "PV1READ",
           num_book = "ST255Q01JA",
           num_transport = "ST251Q01JA",
           num_digital_devices = ST253Q01JA)) %>%
  mutate(gender = recode(gender, 
                         "1" = "Female", 
                         "2" = "Male")) %>%
  mutate(num_book = recode(num_book,
                           "1" = "None",
                           "2" = "1-10",
                           "3" = "11-25",
                           "4" = "26-100",
                           "5" = "101-200",
                           "6" = "201-500",
                           "7" = "500+")) %>%
  mutate(num_transport = recode(num_transport,
                                "1" = "None",
                                "2" = "1",
                                "3" = "2",
                                "4" = "3+")) %>%
  mutate(num_digital_devices = recode (num_digital_devices,
                                       "1" = "None",
                                       "2" = "1",
                                       "3" = "2",
                                       "4" = "3",
                                       "5" = "4",
                                       "6" = "5",
                                       "7" = "6-10",
                                       "8" = "10+"))


stu_qqq$school_ID <- as.factor(stu_qqq$school_ID)
stu_qqq$gender <- as.factor(stu_qqq$gender)
stu_qqq$num_book <- as.factor(stu_qqq$num_book)
stu_qqq$num_book <- factor(stu_qqq$num_book, levels = c('None','1-10','11-25','26-100','101-200','201-500','500+'))
stu_qqq$num_transport <- as.factor(stu_qqq$num_transport)
stu_qqq$num_transport <- factor(stu_qqq$num_transport, levels = c('None','1','2','3+'))
stu_qqq$num_digital_devices <- as.factor(stu_qqq$num_digital_devices)
stu_qqq$num_digital_devices <- factor(stu_qqq$num_digital_devices, levels = c('None','1','2','3','4','5','6-10','10+'))
```

### Overview

```{r}
glimpse(stu_qqq)
```

## Exploratory Data Analysis (EDA)

### 1. Gender

```{r}
ggplot(data = stu_qqq,
       aes(x = gender)) +
  geom_bar(width = 0.5)+
  theme_minimal()
```

::: panel-tabset
#### Math

```{r}
#| code-fold: true
#| code-summary: "Show the code"
stats <- data.frame(gender = as.factor(c('Female','Male')),
                    mean = c(mean(stu_qqq$math[stu_qqq$gender == "Female"]),
                             mean(stu_qqq$math[stu_qqq$gender == "Male"])),
                    median = c(median(stu_qqq$math[stu_qqq$gender == "Female"]),
                               median(stu_qqq$math[stu_qqq$gender == "Male"])) )

ggplot(data = stu_qqq,
       aes(y = math)) +
  geom_histogram(bins = 10,
                 color = 'grey50',
                 fill = 'grey90') +
  facet_wrap(~ gender) +
  geom_hline(data = stats,
             mapping = aes(yintercept=mean),
             color = "red") +
  geom_hline(data = stats,
             mapping = aes(yintercept=median),
             color = "blue") +
  annotate(
    'text',
    x = Inf,
    y = Inf,
    hjust = 1,
    vjust = 2.1,
    label = paste("MEAN"),
    color = "red"
  ) +
  annotate(
    'text',
    x = Inf,
    y = Inf,
    hjust = 1,
    vjust = 1,
    label = paste("MEDIAN"),
    color = "blue"
  ) +
  theme_minimal()
```

#### Science

```{r}
#| code-fold: true
#| code-summary: "Show the code"
stats <- data.frame(gender = as.factor(c('Female','Male')),
                    mean = c(mean(stu_qqq$science[stu_qqq$gender == "Female"]),
                             mean(stu_qqq$science[stu_qqq$gender == "Male"])),
                    median = c(median(stu_qqq$science[stu_qqq$gender == "Female"]),
                               median(stu_qqq$science[stu_qqq$gender == "Male"])) )

ggplot(data = stu_qqq,
       aes(y = science)) +
  geom_histogram(bins = 10,
                 color = 'grey50',
                 fill = 'grey90') +
  facet_wrap(~ gender) +
  geom_hline(data = stats,
             mapping = aes(yintercept=mean),
             color = "red") +
  geom_hline(data = stats,
             mapping = aes(yintercept=median),
             color = "blue") +
  annotate(
    'text',
    x = Inf,
    y = Inf,
    hjust = 1,
    vjust = 2.1,
    label = paste("MEAN"),
    color = "red"
  ) +
  annotate(
    'text',
    x = Inf,
    y = Inf,
    hjust = 1,
    vjust = 1,
    label = paste("MEDIAN"),
    color = "blue"
  ) +
  theme_minimal()
```

#### Reading

```{r}
#| code-fold: true
#| code-summary: "Show the code"
stats <- data.frame(gender = as.factor(c('Female','Male')),
                    mean = c(mean(stu_qqq$read[stu_qqq$gender == "Female"]),
                             mean(stu_qqq$read[stu_qqq$gender == "Male"])),
                    median = c(median(stu_qqq$read[stu_qqq$gender == "Female"]),
                               median(stu_qqq$read[stu_qqq$gender == "Male"])) )

ggplot(data = stu_qqq,
       aes(y = read)) +
  geom_histogram(bins = 10,
                 color = 'grey50',
                 fill = 'grey90') +
  facet_wrap(~ gender) +
  geom_hline(data = stats,
             mapping = aes(yintercept=mean),
             color = "red") +
  geom_hline(data = stats,
             mapping = aes(yintercept=median),
             color = "blue") +
  annotate(
    'text',
    x = Inf,
    y = Inf,
    hjust = 1,
    vjust = 2.1,
    label = paste("MEAN"),
    color = "red"
  ) +
  annotate(
    'text',
    x = Inf,
    y = Inf,
    hjust = 1,
    vjust = 1,
    label = paste("MEDIAN"),
    color = "blue"
  ) +
  theme_minimal()
```
:::

### 2. School

```{r}
length(unique(stu_qqq$school_ID))
```

```{r}
average_math_SG <- mean(stu_qqq$math)
average_scie_SG <- mean(stu_qqq$science)
average_read_SG <- mean(stu_qqq$read)

stu_qqq_sch <- stu_qqq %>%
  group_by(school_ID) %>%
  mutate(average_math_diff = abs(mean(math)-average_math_SG),
         average_science_diff = abs(mean(science)-average_scie_SG),
         average_read_diff = abs(mean(read)-average_read_SG)) %>%
  select(school_ID, average_math_diff, average_science_diff, average_read_diff) %>%
  unique() 

```

```{r}
#| code-fold: true
#| code-summary: "Show the code"

p1 <- ggplot(data = stu_qqq_sch,
       aes(y = average_math_diff)) +
  geom_boxplot(width = 0.1) +
  stat_summary(aes(x = 0),
               geom = "point",       
               fun.y ="mean",         
               colour ="red", 
               size=1) +
  xlim(c(-0.5,0.5)) +
  ylim(c(0,220)) +
  scale_x_continuous(NULL, breaks = NULL) +
  theme_minimal()

p2 <- ggplot(data = stu_qqq_sch,
       aes(y = average_science_diff)) +
  geom_boxplot(width = 0.1) +
  stat_summary(aes(x = 0),
               geom = "point",       
               fun.y ="mean",         
               colour ="red", 
               size=1) +
  xlim(c(-0.5,0.5)) +
  ylim(c(0,220)) +
  scale_x_continuous(NULL, breaks = NULL) +
  theme_minimal()

p3 <- ggplot(data = stu_qqq_sch,
       aes(y = average_read_diff)) +
  geom_boxplot(width = 0.1) +
  stat_summary(aes(x = 0),
               geom = "point",       
               fun.y ="mean",         
               colour ="red", 
               size=1) +
  xlim(c(-0.5,0.5)) +
  ylim(c(0,220)) +
  scale_x_continuous(NULL, breaks = NULL) +
  theme_minimal()

p1|p2|p3
```

### 3. Social Economic 1: Book Ownership

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq,
       aes(x = num_book)) +
  geom_bar()+
  theme_minimal()
```

```{r}
#| code-fold: true
#| code-summary: "Show wrangling code"
stu_qqq_book <- stu_qqq %>%
  group_by(num_book) %>%
  mutate(average_math = mean(math),
         average_science = mean(science),
         average_read = mean(read)) %>%
  select(num_book, average_math, average_science, average_read) %>%
  unique() 
```

::: panel-tabset
#### Math

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_book,
       aes(x=num_book, y=average_math)) +
  geom_col() +
  theme_minimal()
```

#### Science

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_book,
       aes(x=num_book, y=average_science)) +
  geom_col() +
  theme_minimal()
```

#### Read

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_book,
       aes(x=num_book, y=average_read)) +
  geom_col() +
  theme_minimal()
```
:::

### 4. Social Economic 2: Vehicle Ownership

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq,
       aes(x = num_transport)) +
  geom_bar()+
  theme_minimal()
```

```{r}
#| code-fold: true
#| code-summary: "Show wrangling code"
stu_qqq_transport <- stu_qqq %>%
  group_by(num_transport) %>%
  mutate(average_math = mean(math),
         average_science = mean(science),
         average_read = mean(read)) %>%
  select(num_transport, average_math, average_science, average_read) %>%
  unique() 
```

::: panel-tabset
#### Math

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_transport,
       aes(x=num_transport, y=average_math)) +
  geom_col() +
  theme_minimal()
```

#### Science

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_transport,
       aes(x=num_transport, y=average_science)) +
  geom_col() +
  theme_minimal()
```

#### Read

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_transport,
       aes(x=num_transport, y=average_read)) +
  geom_col() +
  theme_minimal()
```
:::

### 5. Social Economic 3: Digital Device Ownership

```{r}
ggplot(data = stu_qqq,
       aes(x = num_digital_devices)) +
  geom_bar()+
  theme_minimal()
```

```{r}
#| code-fold: true
#| code-summary: "Show wrangling code"
stu_qqq_digital <- stu_qqq %>%
  group_by(num_digital_devices) %>%
  mutate(average_math = mean(math),
         average_science = mean(science),
         average_read = mean(read)) %>%
  select(num_digital_devices, average_math, average_science, average_read) %>%
  unique() 
```

::: panel-tabset
#### Math

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_digital,
       aes(x=num_digital_devices, y=average_math)) +
  geom_col() +
  theme_minimal()
```

#### Science

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_digital,
       aes(x=num_digital_devices, y=average_science)) +
  geom_col() +
  theme_minimal()
```

#### Read

```{r}
#| code-fold: true
#| code-summary: "Show the code"
ggplot(data = stu_qqq_digital,
       aes(x=num_digital_devices, y=average_read)) +
  geom_col() +
  theme_minimal()
```
:::
